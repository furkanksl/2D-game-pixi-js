<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="js/pixi.min.js"></script>
    <script>
        let app;
        let player;
        let keys = {};
        let keysDiv;
        let bullets = [];
        let bulletSpeed = 10;
        let bullet;

        window.onload = function() {
                app = new PIXI.Application({
                    width: 600,
                    height: 600,
                    backgroundColor: 0x000000
                });

                //document.body.appendChild(app.view);
                document.querySelector("#gameDiv").appendChild(app.view);
                // player object
                /* player = new PIXI.Sprite.from("images/player.png");
                player.anchor.set(0.5, -3.5);
                player.x = app.view.width / 2;
                player.y = app.view.height / 2;

                app.stage.addChild(player); */

                //keyboard event handlers

                window.addEventListener("keydown", keysDown)
                window.addEventListener("keyup", keysUp)


                app.ticker.add(gameLoop);
                keysDiv = document.querySelector('#keys')


                //preload assets
                app.loader.baseUrl = "images";
                app.loader
                    .add("sprite01", "bullet01.png")
                    .add("sprite02", "bullet02.png")
                    .add("sprite03", "bullet03.png")
                    .add("sprite04", "bullet04.png")
                    .add("sprite05", "bullet05.png")
                    .add("sprite06", "bullet06.png")
                    .add("sprite07", "bullet07.png")
                    .add("sprite08", "bullet08.png")
                    .add("sprite09", "bullet09.png")
                    .add("sprite10", "bullet10.png")
                    .add("bullet", "bullet.png")
                    .add("player", "player.png")

                app.loader.onProgress.add(showProgress);
                app.loader.onComplete.add(doneLoading);
                app.loader.onError.add(reportError);

                app.loader.load();

                /* 

                    //mouse interactions
                    app.stage.interactive = true;
                    app.stage.on("pointermove", movePlayer);

                    function movePlayer(e) {
                        let position = e.data.global;

                        if (position.x < app.view.width - 20 && position.x > 20)
                            player.x = position.x;
                        //player.y = position.y;
                    }
                     */

            }
            // left arrow = 37
            // right arrow = 39
        function keysDown(e) {
            keys[e.keyCode] = true;
            //console.log(e.keyCode); 
        }

        function keysUp(e) {
            keys[e.keyCode] = false;
            //console.log(e.keyCode);
        }

        function gameLoop() {
            //keysDiv.innerHtml = JSON.stringify(keys);

            // left arrow
            if (keys["37"]) {
                if (player.x > 20)
                    player.x -= 5;
            }
            // right arrow
            if (keys["39"]) {
                if (player.x < app.view.width - 20)
                    player.x += 5;
            }

            // space
            if (keys["32"]) {
                if (this.timer) {
                    window.clearTimeout(this.timer);
                }
                this.timer = window.setTimeout(function() {

                    fireBullet();

                }, 100);

            }
            updateBullet();


        }

        function showProgress(e) {
            console.log(e.progress);
        }

        function doneLoading(e) {
            console.log('DONE LOADING!');
            player = PIXI.Sprite.from(app.loader.resources.player.texture);
            player.anchor.set(0.5, -3.5);
            player.x = app.view.width / 2;
            player.y = app.view.height / 2;
            app.stage.addChild(player);
        }

        function reportError(e) {
            console.log("ERROR : " + e.message);
        }

        function fireBullet(e) {

            console.log("FIRE!");
            let tempBullet = createBullet();
            bullets.push(tempBullet);
            console.log(bullets);




        }

        function createBullet() {
            bullet = PIXI.Sprite.from(app.loader.resources.bullet.texture);
            bullet.anchor.set(0.5, -8.5);
            bullet.x = player.x;
            bullet.y = player.y;
            bullet.speed = bulletSpeed;
            app.stage.addChild(bullet);

            return bullet;
        }

        function updateBullet(delta) {
            for (let index = 0; index < bullets.length; index++) {
                bullets[index].position.y -= bullets[index].speed;
                //console.log(bullets[index].position.y);
                if (bullets[index].position.y < -200) {
                    app.stage.removeChild(bullets[index]);
                    bullets.splice(index, 1);
                }
            }

        }
    </script>
</head>

<body>
    <!-- <div id="keys"></div> -->
    <div id="gameDiv"></div>
</body>

</html>